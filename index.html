<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Space Shooter: Stable Version</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; user-select: none; }
    
    /* ИНТЕРФЕЙС */
    #hud {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 10;
    }
    #question-container {
      position: absolute; top: 30px; width: 100%; text-align: center;
    }
    .q-box {
      background: rgba(0, 0, 0, 0.8);
      border: 3px solid #00ff00;
      box-shadow: 0 0 15px #00ff00;
      border-radius: 10px;
      padding: 15px 40px;
      color: #fff;
      font-family: monospace;
      font-size: 32px;
      font-weight: bold;
      display: inline-block;
    }
    #crosshair {
      position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
      transform: translate(-50%, -50%);
      border: 2px solid rgba(255, 0, 0, 0.8);
      border-radius: 50%;
      background: rgba(255, 0, 0, 0.2);
    }
    .hint {
        position: absolute; bottom: 15%; width: 100%; text-align: center; 
        color: rgba(255,255,255,0.7); font-family: sans-serif; font-size: 16px;
        animation: pulse 2s infinite;
    }
    @keyframes pulse { 0% {opacity: 0.5;} 50% {opacity: 1;} 100% {opacity: 0.5;} }

    #win-screen {
      display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: black; flex-direction: column; justify-content: center; align-items: center;
      color: lime; font-family: monospace; pointer-events: auto;
    }
  </style>

  <script>
    // --- УРОВНИ ---
    const levels = [
      { q: "2 + 2 = ?", a: [ {t:"4", c:true}, {t:"5", c:false}, {t:"22", c:false} ] },
      { q: "10 - 3 = ?", a: [ {t:"7", c:true}, {t:"6", c:false}, {t:"13", c:false} ] },
      { q: "5 x 5 = ?", a: [ {t:"25", c:true}, {t:"10", c:false}, {t:"50", c:false} ] }
    ];

    // --- ЗВУКИ ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      
      if (type === 'shoot') { 
        osc.frequency.setValueAtTime(800, now);
        osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        osc.start(now); osc.stop(now + 0.1);
      } else if (type === 'hit') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(200, now);
        osc.frequency.linearRampToValueAtTime(50, now + 0.3);
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.3);
        osc.start(now); osc.stop(now + 0.3);
      }
    }

    // --- КОМПОНЕНТ ПОВЕДЕНИЯ ТАРЕЛКИ ---
    AFRAME.registerComponent('ufo-logic', {
      schema: {
        isCorrect: {default: false},
        speed: {default: 1},
        offset: {default: 0}
      },
      init: function() {
        this.angle = this.data.offset;
        // Слушаем КЛИК (Это встроенное событие A-Frame, оно надежное)
        this.el.addEventListener('click', this.onHit.bind(this));
        
        // Слушаем наведение курсора (чтобы подсветить)
        this.el.addEventListener('mouseenter', () => {
            this.el.querySelector('.ufo-ring').setAttribute('color', 'white');
        });
        this.el.addEventListener('mouseleave', () => {
            this.el.querySelector('.ufo-ring').setAttribute('color', this.data.isCorrect ? '#00ffff' : '#ff00ff');
        });
      },
      tick: function(time, timeDelta) {
        if (!this.el.object3D.visible) return;

        // Движение по орбите
        this.angle += (this.data.speed * 0.0005) * timeDelta;
        const r = 8; // Радиус орбиты
        const x = Math.cos(this.angle) * r;
        const z = Math.sin(this.angle) * r;
        // Покачивание вверх-вниз
        const y = Math.sin(time * 0.002 + this.data.offset) * 2 + 3;

        this.el.setAttribute('position', {x, y, z});
        this.el.object3D.rotation.y += 0.02; // Вращение вокруг оси
      },
      onHit: function() {
        // Запускаем звук и анимацию оружия глобально
        document.querySelector('[game-manager]').components['game-manager'].fireEffect();

        if (this.data.isCorrect) {
          playSound('hit');
          // Эффект взрыва (частицы)
          this.createExplosion(this.el.getAttribute('position'));
          
          // Скрываем тарелку
          this.el.setAttribute('visible', false);
          this.el.classList.remove('collidable'); // Отключаем кликабельность

          // Сообщаем игре, что уровень пройден
          setTimeout(() => {
             document.querySelector('[game-manager]').components['game-manager'].nextLevel();
          }, 1000);
        } else {
          // Ошибка
          playSound('shoot'); // Просто звук выстрела
          const sphere = this.el.querySelector('.ufo-core');
          sphere.setAttribute('color', 'red');
          setTimeout(() => sphere.setAttribute('color', '#333'), 300);
        }
      },
      createExplosion: function(pos) {
          // Создаем облако частиц вручную
          for(let i=0; i<10; i++) {
              const p = document.createElement('a-sphere');
              p.setAttribute('radius', 0.2);
              p.setAttribute('color', 'orange');
              p.setAttribute('position', pos);
              // Разлетаются в разные стороны
              const dest = `${pos.x + (Math.random()-0.5)*5} ${pos.y + (Math.random()-0.5)*5} ${pos.z + (Math.random()-0.5)*5}`;
              p.setAttribute('animation', `property: position; to: ${dest}; dur: 500; easing: easeOutQuad`);
              p.setAttribute('animation__fade', `property: opacity; to: 0; dur: 500`);
              this.el.sceneEl.appendChild(p);
              setTimeout(()=>p.remove(), 500);
          }
      }
    });

    // --- МЕНЕДЖЕР ИГРЫ ---
    AFRAME.registerComponent('game-manager', {
      init: function () {
        this.levelIdx = 0;
        this.container = document.getElementById('ufo-container');
        this.qText = document.getElementById('q-text');
        this.weapon = document.getElementById('weapon-model');
        this.laser = document.getElementById('laser-beam');

        // Создаем звезды (Фон)
        this.createStars();
        
        // Глобальный клик для визуального эффекта (отдача и лазер)
        // Но логика попадания теперь внутри 'ufo-logic'
        document.addEventListener('mousedown', () => this.fireEffect());

        this.loadLevel(0);
      },
      fireEffect: function() {
        playSound('shoot');
        // Анимация отдачи
        this.weapon.emit('recoil');
        // Показываем лазер
        this.laser.setAttribute('visible', true);
        setTimeout(() => this.laser.setAttribute('visible', false), 80);
      },
      nextLevel: function() {
          this.levelIdx++;
          this.loadLevel(this.levelIdx);
      },
      loadLevel: function(idx) {
        if (idx >= levels.length) {
            document.getElementById('win-screen').style.display = 'flex';
            document.exitPointerLock();
            return;
        }
        const data = levels[idx];
        this.qText.innerText = data.q;
        this.container.innerHTML = '';

        data.a.forEach((ans, i) => {
            const el = document.createElement('a-entity');
            el.setAttribute('ufo-logic', `isCorrect: ${ans.c}; offset: ${i*2}; speed: ${1 + Math.random()}`);
            el.setAttribute('class', 'collidable'); // Класс для луча
            el.setAttribute('look-at', '[camera]');

            // Модель
            el.innerHTML = `
                <a-cone radius-bottom="1.2" radius-top="0.5" height="0.5" color="#555"></a-cone>
                <a-ring class="ufo-ring" radius-inner="1.2" radius-outer="1.4" color="${ans.c ? '#00ffff' : '#ff00ff'}" rotation="-90 0 0"></a-ring>
                <a-sphere class="ufo-core" position="0 0.2 0" radius="0.6" color="#333" opacity="0.9"></a-sphere>
                <a-text value="${ans.t}" align="center" position="0 1.5 0" scale="5 5 5" color="#00ff00"></a-text>
                <a-sphere radius="2" visible="false"></a-sphere>
            `;
            this.container.appendChild(el);
        });
      },
      createStars: function() {
          const s = document.getElementById('stars');
          for(let i=0; i<300; i++) {
              const star = document.createElement('a-sphere');
              const pos = `${(Math.random()-0.5)*100} ${(Math.random()-0.5)*100} ${(Math.random()-0.5)*100}`;
              star.setAttribute('position', pos);
              star.setAttribute('radius', Math.random()*0.15);
              star.setAttribute('color', 'white');
              star.setAttribute('shader', 'flat');
              s.appendChild(star);
          }
      }
    });
  </script>
</head>
<body>

  <div id="hud">
    <div id="question-container"><div class="q-box" id="q-text">Loading...</div></div>
    <div id="crosshair"></div>
    <div class="hint">КЛИКНИ ПО ЭКРАНУ, ЧТОБЫ НАЧАТЬ ИГРУ</div>
    <div id="win-screen">
      <h1>ПОБЕДА!</h1>
      <button onclick="location.reload()" style="padding:15px; font-size:20px; background:lime; cursor:pointer;">ИГРАТЬ СНОВА</button>
    </div>
  </div>

  <a-scene background="color: #050510">
    <a-entity game-manager></a-entity>
    <a-entity id="stars"></a-entity>

    <a-camera look-controls="pointerLockEnabled: true">
        
        <a-entity id="weapon-model" position="0.4 -0.4 -0.6">
            <a-box width="0.1" height="0.1" depth="0.5" color="#444"></a-box>
            <a-box width="0.12" height="0.2" depth="0.15" position="0 -0.1 0.15" color="#222"></a-box>
            <a-animation attribute="position" begin="recoil" from="0.4 -0.4 -0.5" to="0.4 -0.4 -0.6" dur="100"></a-animation>
            
            <a-cylinder id="laser-beam" visible="false" position="0 0 -10" rotation="90 0 0" radius="0.02" height="20" color="red" opacity="0.8" material="shader: flat"></a-cylinder>
        </a-entity>

        <a-cursor 
            fuse="false" 
            raycaster="objects: .collidable; far: 100; interval: 100"
            opacity="0"
            position="0 0 -1">
        </a-cursor>

    </a-camera>

    <a-entity id="ufo-container"></a-entity>
    <a-light type="ambient" color="#666"></a-light>
    <a-light type="point" intensity="1" position="-2 4 4"></a-light>
  </a-scene>
</body>
</html>
