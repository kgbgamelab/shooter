<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Space Shooter 360 - Fixed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; user-select: none; }
    
    #hud {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 10;
    }

    #question-box {
      position: absolute; top: 20px; width: 100%; text-align: center;
    }
    .q-inner {
      background: rgba(0, 20, 50, 0.9);
      border: 2px solid #00ffff;
      border-radius: 15px;
      padding: 15px 30px;
      display: inline-block;
      color: #00ffff;
      font-size: 24px;
      box-shadow: 0 0 15px #00ffff;
      max-width: 80%;
    }
    .q-inner img { max-height: 150px; margin-top: 10px; border-radius: 5px; }

    #weapon {
      position: absolute; bottom: 0; right: 25%; width: 30vw; height: 30vw;
      /* Картинка бластера */
      background-image: url('https://cdn.pixabay.com/photo/2017/01/31/15/27/sci-fi-2025179_1280.png'); 
      background-size: contain; background-repeat: no-repeat; background-position: bottom center;
      transition: transform 0.1s;
    }
    .recoil { transform: translateY(30px) scale(0.95); }

    #crosshair {
      position: absolute; top: 50%; left: 50%; width: 40px; height: 40px;
      transform: translate(-50%, -50%);
      border: 2px solid rgba(255, 50, 50, 0.8); border-radius: 50%;
    }
    #crosshair::after {
      content: ''; position: absolute; top: 50%; left: 50%; width: 4px; height: 4px;
      background: red; transform: translate(-50%, -50%); border-radius: 50%;
    }

    #win-screen {
      display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.95); color: white;
      flex-direction: column; justify-content: center; align-items: center;
      pointer-events: auto; z-index: 20;
    }
    button { padding: 15px 30px; font-size: 20px; cursor: pointer; background: #00ffff; border: none; border-radius: 5px; margin-top: 20px; font-weight: bold;}
  </style>

  <script>
    // --- КОНФИГУРАЦИЯ ---
    const gameConfig = {
      // Используем безопасный фон (сетка), чтобы точно заработало.
      // Если хотите свою картинку, положите её в папку с index.html и напишите 'background: "./my-image.jpg"'
      background: "", 
      
      levels: [
        {
          questionType: "text", 
          questionContent: "Чему равен определитель матрицы 2x2, если ad - bc = 10?",
          targets: [
            { type: "text", content: "10", isCorrect: true },
            { type: "text", content: "0", isCorrect: false },
            { type: "text", content: "-10", isCorrect: false }
          ]
        },
        {
          questionType: "text",
          questionContent: "Столица Франции?",
          targets: [
            { type: "text", content: "Париж", isCorrect: true },
            { type: "text", content: "Лондон", isCorrect: false },
            { type: "text", content: "Берлин", isCorrect: false }
          ]
        },
        {
          questionType: "image",
          // Пример картинки с википедии (может не грузиться в 3D, но в 2D окне загрузится)
          questionContent: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Synthese%2B.svg/320px-Synthese%2B.svg.png", 
          hint: "Какой это тип смешения цветов?",
          targets: [
            { type: "text", content: "Аддитивный", isCorrect: true },
            { type: "text", content: "Субтрактивный", isCorrect: false },
            { type: "text", content: "Никакой", isCorrect: false }
          ]
        }
      ]
    };

    // --- АУДИО СИСТЕМА (Синтезатор) ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(type) {
      // Пытаемся разблокировать аудио при каждом вызове (нужно для первого клика)
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      
      const now = audioCtx.currentTime;
      if (type === 'shoot') {
        osc.type = 'square'; 
        osc.frequency.setValueAtTime(300, now);
        osc.frequency.exponentialRampToValueAtTime(50, now + 0.15);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
        osc.start(now); osc.stop(now + 0.15);
      } else if (type === 'win') {
        osc.type = 'sine'; 
        osc.frequency.setValueAtTime(400, now);
        osc.frequency.linearRampToValueAtTime(800, now + 0.1);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.5);
        osc.start(now); osc.stop(now + 0.5);
      } else if (type === 'error') {
        osc.type = 'sawtooth'; 
        osc.frequency.setValueAtTime(100, now);
        osc.frequency.linearRampToValueAtTime(50, now + 0.3);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.3);
        osc.start(now); osc.stop(now + 0.3);
      }
    }

    // --- ЛОГИКА ИГРЫ ---
    AFRAME.registerComponent('game-manager', {
      init: function () {
        this.currentLevelIndex = 0;
        this.score = 0;
        
        this.container = document.getElementById('ufo-container');
        this.qTextContainer = document.getElementById('q-content');
        this.bg = document.getElementById('sky-bg');
        this.weapon = document.getElementById('weapon');
        this.winScreen = document.getElementById('win-screen');
        this.finalScore = document.getElementById('final-score');

        // Установка фона (если задан)
        if(gameConfig.background) {
            this.bg.setAttribute('src', gameConfig.background);
        } else {
            // Если фона нет - ставим красивый цвет
            this.bg.setAttribute('color', '#000011');
        }

        // Глобальный слушатель клика для анимации оружия и звука выстрела
        // (Логика попадания теперь внутри самих тарелок)
        window.addEventListener('mousedown', () => {
          this.weapon.classList.remove('recoil');
          void this.weapon.offsetWidth; 
          this.weapon.classList.add('recoil');
          playSound('shoot');
        });

        this.loadLevel(0);
      },

      loadLevel: function (index) {
        if (index >= gameConfig.levels.length) {
          this.finishGame();
          return;
        }
        this.currentLevelIndex = index;
        const levelData = gameConfig.levels[index];

        // Очистка
        this.container.innerHTML = '';

        // HUD Вопрос
        if (levelData.questionType === 'image') {
           this.qTextContainer.innerHTML = `<img src="${levelData.questionContent}"><br>${levelData.hint || ''}`;
        } else {
           this.qTextContainer.innerText = levelData.questionContent;
        }

        // Позиции тарелок
        const positions = [
          "-4 2 -6", "0 3 -8", "4 2 -6", 
          "-6 4 -4", "6 1 -4"
        ];
        
        levelData.targets.forEach((target, i) => {
          if (i >= positions.length) return;

          // Контейнер для НЛО + Ответа
          const el = document.createElement('a-entity');
          el.setAttribute('position', positions[i]);
          el.setAttribute('look-at', '[camera]'); 
          
          // ВАЖНО: Добавляем класс 'clickable' и слушатель событий прямо на объект
          // Это избавляет от ошибки с Raycaster
          el.setAttribute('class', 'clickable');

          // --- Визуал НЛО ---
          const ufoGroup = document.createElement('a-entity');
          ufoGroup.innerHTML = `
            <a-cone radius-bottom="1.2" radius-top="0.4" height="0.4" color="#444"></a-cone>
            <a-sphere position="0 0.2 0" radius="0.5" color="${target.isCorrect ? '#333' : '#333'}" opacity="0.8"></a-sphere>
            <a-ring radius-inner="1.2" radius-outer="1.5" color="#00ffff" rotation="-90 0 0" opacity="0.6"></a-ring>
          `;
          
          // Анимация вращения кольца
          const ring = ufoGroup.querySelector('a-ring');
          ring.setAttribute('animation', 'property: rotation; to: -90 360 0; loop: true; dur: 3000; easing: linear');

          el.appendChild(ufoGroup);

          // --- Ответ (Текст или Картинка) ---
          const answerContainer = document.createElement('a-entity');
          answerContainer.setAttribute('position', '0 1.2 0'); 
          
          if (target.type === 'image') {
            const img = document.createElement('a-image');
            img.setAttribute('src', target.content);
            img.setAttribute('width', 2); img.setAttribute('height', 2);
            answerContainer.appendChild(img);
          } else {
            // Текст
            const text = document.createElement('a-text');
            text.setAttribute('value', target.content);
            text.setAttribute('align', 'center');
            text.setAttribute('scale', '3 3 3');
            text.setAttribute('color', '#00ffff');
            
            // Черная подложка
            const bg = document.createElement('a-plane');
            bg.setAttribute('width', '2.5'); bg.setAttribute('height', '1');
            bg.setAttribute('color', 'black'); bg.setAttribute('opacity', '0.7');
            bg.setAttribute('position', '0 0 -0.1');
            
            answerContainer.appendChild(bg);
            answerContainer.appendChild(text);
          }
          el.appendChild(answerContainer);

          // ЛОГИКА КЛИКА (Теперь простая и надежная)
          // Используем 'click', который A-Frame сам посылает, когда курсор на объекте и нажата кнопка мыши
          el.addEventListener('click', () => {
             if (target.isCorrect) {
               playSound('win');
               // Анимация успеха
               el.setAttribute('animation', 'property: scale; to: 0 0 0; dur: 200');
               setTimeout(() => {
                 this.score++;
                 this.loadLevel(this.currentLevelIndex + 1);
               }, 500);
             } else {
               playSound('error');
               // Красная вспышка
               const cone = ufoGroup.querySelector('a-cone');
               cone.setAttribute('color', 'red');
               setTimeout(() => cone.setAttribute('color', '#444'), 300);
             }
          });
          
          // Анимация покачивания
          el.setAttribute('animation', `property: position; dir: alternate; dur: ${2000 + Math.random()*1000}; to: ${positions[i].replace(/ (\d+)/, (m, y) => ' ' + (parseFloat(y)+0.5))}; loop: true; easing: easeInOutSine`);

          this.container.appendChild(el);
        });
      },

      finishGame: function() {
        this.finalScore.innerText = this.score + " / " + gameConfig.levels.length;
        this.winScreen.style.display = 'flex';
      }
    });

  </script>
</head>
<body>

  <div id="hud">
    <div id="question-box">
      <div class="q-inner" id="q-content">Загрузка...</div>
    </div>
    <div id="crosshair"></div>
    <div id="weapon"></div>
    
    <div id="win-screen">
      <h1>МИССИЯ ВЫПОЛНЕНА!</h1>
      <h2>СЧЕТ: <span id="final-score">0</span></h2>
      <button onclick="location.reload()">ЕЩЕ РАЗ</button>
    </div>
  </div>

  <a-scene loading-screen="dotsColor: cyan; backgroundColor: black">
    <a-assets></a-assets>

    <a-entity game-manager></a-entity>

    <a-camera look-controls>
      <a-cursor 
        raycaster="objects: .clickable"
        fuse="false"
        opacity="0"
        position="0 0 -1"
        rayOrigin="mouse"> </a-cursor>
    </a-camera>

    <a-entity id="ufo-container"></a-entity>

    <a-light type="ambient" color="#444"></a-light>
    <a-light type="point" intensity="1" position="2 4 4"></a-light>

    <a-sky id="sky-bg" src="" color="#000"></a-sky>
    <a-entity position="0 0 0" particle-system="preset: dust; color: #FFF; count: 1000"></a-entity>

  </a-scene>
</body>
</html>
