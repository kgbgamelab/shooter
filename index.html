<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>FPS Math Shooter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; user-select: none; }
    
    /* Интерфейс */
    #hud {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 10;
    }
    #question-box {
      position: absolute; top: 20px; width: 100%; text-align: center;
    }
    .q-inner {
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid lime;
      border-radius: 8px;
      padding: 15px 30px;
      display: inline-block;
      color: white;
      font-family: monospace;
      font-size: 28px;
      font-weight: bold;
    }
    /* Прицел в центре */
    #crosshair {
      position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
      transform: translate(-50%, -50%);
      background: rgba(255, 0, 0, 0.5);
      border-radius: 50%;
      border: 2px solid white;
    }
    /* Экран победы */
    #win-screen {
      display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: black; color: lime;
      flex-direction: column; justify-content: center; align-items: center;
      font-family: monospace;
      pointer-events: auto; z-index: 20;
    }
    .start-hint {
        position: absolute; bottom: 20%; width: 100%; text-align: center; 
        color: white; font-family: sans-serif; opacity: 0.7; animation: blink 2s infinite;
    }
    @keyframes blink { 50% { opacity: 0.2; } }
  </style>

  <script>
    // --- ДАННЫЕ ИГРЫ ---
    const gameConfig = {
      levels: [
        {
          question: "2 + 2 = ?",
          targets: [
            { text: "4", isCorrect: true }, { text: "5", isCorrect: false }, { text: "22", isCorrect: false }
          ]
        },
        {
          question: "Столица России?",
          targets: [
            { text: "Москва", isCorrect: true }, { text: "Омск", isCorrect: false }, { text: "Париж", isCorrect: false }
          ]
        },
        {
          question: "5 x 5 = ?",
          targets: [
            { text: "25", isCorrect: true }, { text: "10", isCorrect: false }, { text: "55", isCorrect: false }
          ]
        }
      ]
    };

    // --- ЗВУКИ (Синтезатор браузера) ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      
      if (type === 'shoot') {
        osc.frequency.setValueAtTime(800, now);
        osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        osc.start(now); osc.stop(now + 0.1);
      } else if (type === 'hit') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(400, now);
        osc.frequency.linearRampToValueAtTime(800, now + 0.1);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.2);
        osc.start(now); osc.stop(now + 0.2);
      }
    }

    // --- ЛОГИКА ---
    AFRAME.registerComponent('game-manager', {
      init: function () {
        this.level = 0;
        this.score = 0;
        this.container = document.getElementById('targets');
        this.qText = document.getElementById('q-text');
        
        // Анимация выстрела пистолета
        const weapon = document.getElementById('my-weapon');
        document.addEventListener('mousedown', () => {
            playSound('shoot');
            weapon.setAttribute('animation', 'property: position; from: 0.3 -0.3 -0.4; to: 0.3 -0.2 -0.3; dur: 50; easing: easeOutQuad');
            setTimeout(() => {
                weapon.setAttribute('animation', 'property: position; to: 0.3 -0.4 -0.5; dur: 100; easing: easeOutQuad');
            }, 50);
        });

        this.loadLevel(0);
      },

      loadLevel: function (index) {
        if (index >= gameConfig.levels.length) {
            document.getElementById('win-screen').style.display = 'flex';
            document.getElementById('final-score').innerText = this.score;
            document.exitPointerLock(); // Освобождаем мышь в конце
            return;
        }
        this.level = index;
        const data = gameConfig.levels[index];
        this.qText.innerText = data.question;
        this.container.innerHTML = '';

        const positions = ["-4 2 -6", "0 3 -8", "4 2 -6"]; // Позиции тарелок

        data.targets.forEach((target, i) => {
          const el = document.createElement('a-entity');
          el.setAttribute('position', positions[i] || "0 0 -5");
          el.setAttribute('look-at', '[camera]');
          el.setAttribute('class', 'clickable'); // ВАЖНО для луча

          // Модель тарелки (Конус + Сфера)
          const ufoColor = target.isCorrect ? '#222' : '#222'; // Одинаковый цвет, чтобы не палить ответ
          el.innerHTML = `
            <a-cone radius-bottom="1.5" radius-top="0.5" height="0.5" color="#555"></a-cone>
            <a-sphere position="0 0.3 0" radius="0.7" color="${ufoColor}" opacity="0.9"></a-sphere>
            <a-text value="${target.text}" align="center" position="0 1.5 0" scale="4 4 4" color="#00ff00"></a-text>
            <a-plane position="0 1.5 -0.1" width="3" height="1.2" color="black" opacity="0.6"></a-plane>
          `;

          // Обработка клика
          el.addEventListener('click', () => {
            if (target.isCorrect) {
               playSound('hit');
               this.score++;
               el.setAttribute('visible', 'false'); // Скрываем сбитую
               setTimeout(() => this.loadLevel(this.level + 1), 500);
            } else {
               // Звук ошибки можно добавить
               el.querySelector('a-sphere').setAttribute('color', 'red');
            }
          });

          this.container.appendChild(el);
        });
      }
    });
  </script>
</head>
<body>

  <div id="hud">
    <div id="question-box"><div class="q-inner" id="q-text">Загрузка...</div></div>
    <div id="crosshair"></div>
    <div class="start-hint">КЛИКНИ ПО ЭКРАНУ ЧТОБЫ НАЧАТЬ</div>
    <div id="win-screen">
      <h1>ПОБЕДА!</h1>
      <h2>СЧЕТ: <span id="final-score">0</span></h2>
      <button onclick="location.reload()" style="padding: 20px; font-size: 20px; cursor: pointer;">ИГРАТЬ СНОВА</button>
    </div>
  </div>

  <a-scene loading-screen="dotsColor: lime; backgroundColor: black">
    <a-assets></a-assets>

    <a-entity game-manager></a-entity>

    <a-camera look-controls="pointerLockEnabled: true">
        
        <a-cursor fuse="false" raycaster="objects: .clickable" opacity="0" position="0 0 -1"></a-cursor>

        <a-entity id="my-weapon" position="0.3 -0.4 -0.5">
            <a-box depth="0.8" height="0.1" width="0.1" color="#333" position="0 0 -0.2"></a-box>
            <a-box depth="0.4" height="0.2" width="0.15" color="#555" position="0 -0.05 0.1"></a-box>
            <a-box depth="0.1" height="0.12" width="0.12" color="#000" position="0 0 -0.6"></a-box>
            <a-cylinder height="0.8" radius="0.01" color="red" position="0.06 0.05 -0.2" rotation="90 0 0" opacity="0.6"></a-cylinder>
        </a-entity>

    </a-camera>

    <a-entity id="targets"></a-entity>

    <a-sky color="#050510"></a-sky>
    <a-entity position="0 0 0" particle-system="preset: snow; color: #FFF; count: 4000; size: 0.5"></a-entity>

    <a-light type="ambient" color="#444"></a-light>
    <a-light type="point" intensity="1" position="-2 4 4"></a-light>

  </a-scene>
</body>
</html>
